import React, { useState, useEffect, useMemo } from 'react';
import { Search, MapPin, Box, Zap, ClipboardCheck, Info, Filter, MousePointer2, ShieldAlert, ChevronDown, ChevronUp, Tag, Trophy, Hammer, Sparkles, UserCheck, ShoppingCart, ExternalLink } from 'lucide-react';

/**
 * IMPERIAL SWEATBOX: LIVE DATA ENGINE
 * This version fetches data from 'obtaining_updated.json'
 */

// We'll keep this separate to "merge" stats into the loot data by name.
// You can expand this as you copy-paste from the wiki!
const WIKI_STATS = {
  "7-Yottabyte Storage Component": { tier: 3, lvl: 100, profs: ["Scribing"], stats: [{label: "Storage", value: "Infinite", pos: true}] },
  "Ablution": { tier: 2, lvl: 40, profs: ["Armouring"], stats: [{label: "Health", value: "+200", pos: true}] },
  "Adamastor's Faceplate": { tier: 3, lvl: 100, profs: ["Armouring", "Weaponsmithing"], stats: [{label: "Health", value: "+800", pos: true}] }
};

const PROFESSIONS = ["Armouring", "Tailoring", "Weaponsmithing", "Woodworking", "Jeweling", "Alchemism", "Cooking", "Scribing"];
const TIERS = [0, 1, 2, 3];

const App = () => {
  const [rawDb, setRawDb] = useState({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [filterProf, setFilterProf] = useState([]);
  const [filterTier, setFilterTier] = useState([]);
  const [showDashboard, setShowDashboard] = useState(true);
  const [copyToast, setCopyToast] = useState(null);

  // FETCH DATA FROM LOCAL JSON
  useEffect(() => {
    const loadData = async () => {
      try {
        // When hosted on GitHub, this looks for the file in the same folder
        const response = await fetch('./obtaining_updated.json');
        if (!response.ok) throw new Error("Could not find obtaining_updated.json");
        const data = await response.json();
        setRawDb(data);
        setLoading(false);
      } catch (err) {
        console.error(err);
        setError("Failed to load Imperial Database. Check if obtaining_updated.json is in the folder.");
        setLoading(false);
      }
    };
    loadData();
  }, []);

  // TRANSFORM OBJECT TO ARRAY & APPLY FILTERS
  const results = useMemo(() => {
    const list = Object.entries(rawDb).map(([name, sources]) => {
      const stats = WIKI_STATS[name] || {};
      return {
        name,
        sources,
        tier: stats.tier ?? 0,
        lvl: stats.lvl || 0,
        professions: stats.profs || [],
        stats: stats.stats || [],
        sweatTier: stats.tier === 3 ? 5 : 2 // Auto-assign sweat tier based on rarity
      };
    });

    return list.filter(item => {
      const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.sources.some(s => s.name.toLowerCase().includes(searchTerm.toLowerCase()));
      
      const matchesProf = filterProf.length === 0 || item.professions.some(p => filterProf.includes(p));
      const matchesTier = filterTier.length === 0 || filterTier.includes(item.tier);

      return matchesSearch && matchesProf && matchesTier;
    });
  }, [rawDb, searchTerm, filterProf, filterTier]);

  const copyToClipboard = (coords, sourceName) => {
    // Check if coords are placeholder 0,0,0
    if (coords.x === "0" && coords.y === "0" && coords.z === "0") return;

    const command = `/compass ${coords.x} ${coords.y} ${coords.z}`;
    const el = document.createElement('textarea');
    el.value = command;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);

    setCopyToast({ coords: `${coords.x}, ${coords.y}, ${coords.z}`, mob: sourceName });
    setTimeout(() => setCopyToast(null), 2000);
  };

  const toggleFilter = (list, setList, item) => {
    setList(prev => prev.includes(item) ? prev.filter(i => i !== item) : [...prev, item]);
  };

  if (loading) return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-indigo-600">
      <Trophy size={48} className="animate-bounce mb-4" />
      <p className="font-black uppercase tracking-[0.3em] text-xs">Synchronizing Imperial Intel...</p>
    </div>
  );

  if (error) return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-rose-500 p-10 text-center">
      <ShieldAlert size={48} className="mb-4" />
      <p className="font-black uppercase tracking-widest mb-2">Access Denied / File Missing</p>
      <p className="text-slate-400 text-sm max-w-md">{error}</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
      <div className="bg-indigo-950 text-indigo-200 py-1.5 px-4 text-[9px] font-black uppercase tracking-[0.4em] flex items-center justify-center gap-4 sticky top-0 z-50 shadow-md">
        <ShieldAlert size={12} className="text-amber-400" />
        Imperial Sweatbox - Unauthorized Viewers Will Be Purged
        <ShieldAlert size={12} className="text-amber-400" />
      </div>

      <div className="max-w-[1600px] mx-auto px-4 pt-6">
        {/* Compact Header */}
        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 p-2 rounded-xl shadow-lg">
              <Trophy size={20} className="text-white" fill="currentColor" />
            </div>
            <h1 className="text-2xl font-black tracking-tighter text-slate-900 uppercase italic">
              Imperial <span className="text-indigo-600 text-shadow-sm">Sweatbox</span>
            </h1>
          </div>
          
          <div className="flex items-center gap-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
              <input 
                type="text" 
                placeholder="Search Database..." 
                className="bg-white border border-slate-200 focus:border-indigo-500 rounded-lg py-1.5 pl-9 pr-4 outline-none text-xs font-bold text-slate-700 transition-all w-48 md:w-80"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
            </div>
            <button onClick={() => setShowDashboard(!showDashboard)} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:border-indigo-500 transition-all">
              <Filter size={16} />
            </button>
          </div>
        </div>

        {/* Dashboard */}
        {showDashboard && (
          <div className="bg-white border border-slate-200 rounded-2xl p-4 mb-6 shadow-sm animate-in fade-in slide-in-from-top-2">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <label className="text-[9px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2"><Sparkles size={10} /> Tier Filters</label>
                <div className="flex gap-1">
                  {TIERS.map(t => (
                    <button key={t} onClick={() => toggleFilter(filterTier, setFilterTier, t)} className={`flex-1 py-1.5 rounded-lg text-[10px] font-black border transition-all ${filterTier.includes(t) ? 'bg-amber-500 border-amber-500 text-white shadow-sm' : 'bg-white border-slate-100 text-slate-400 hover:border-slate-300'}`}>T{t}</button>
                  ))}
                </div>
              </div>
              <div className="space-y-2">
                <label className="text-[9px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2"><Hammer size={10} /> Profession Sort</label>
                <div className="flex flex-wrap gap-1">
                  {PROFESSIONS.map(p => (
                    <button key={p} onClick={() => toggleFilter(filterProf, setFilterProf, p)} className={`px-2 py-1 rounded-lg text-[9px] font-bold border transition-all uppercase ${filterProf.includes(p) ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-100 text-slate-400 hover:border-slate-300'}`}>{p}</button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Results Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
          {results.map((item, idx) => (
            <div key={idx} className="bg-white border border-slate-200 rounded-2xl p-4 hover:shadow-lg transition-all flex flex-col relative group">
              <div className="flex justify-between items-start mb-3">
                <div className="text-[8px] font-black text-indigo-500 uppercase px-2 py-0.5 bg-indigo-50 border border-indigo-100 rounded-md">Tier {item.tier}</div>
                <div className="flex gap-0.5">
                  {[...Array(5)].map((_, i) => (
                    <div key={i} className={`w-1 h-2.5 rounded-sm ${i < item.sweatTier ? 'bg-orange-500' : 'bg-slate-100'}`} />
                  ))}
                </div>
              </div>

              <h2 className="text-sm font-black text-slate-900 mb-1 leading-tight uppercase truncate" title={item.name}>{item.name}</h2>
              
              {/* Stats Preview (If Wiki Data Exists) */}
              {item.stats.length > 0 && (
                <div className="bg-slate-50 border border-slate-100 rounded-lg p-2 mb-3">
                  {item.stats.map((s, i) => (
                    <div key={i} className="flex justify-between text-[8px] mb-0.5">
                      <span className="text-slate-400 font-bold">{s.label}</span>
                      <span className={`font-black ${s.pos ? 'text-emerald-600' : 'text-rose-500'}`}>{s.value}</span>
                    </div>
                  ))}
                </div>
              )}

              {/* Dynamic Sources from JSON */}
              <div className="mt-auto space-y-3 pt-3 border-t border-slate-100">
                {item.sources.map((source, sIdx) => (
                  <div key={sIdx} className="space-y-1.5">
                    <div className="flex justify-between items-center text-[9px] font-black uppercase text-indigo-400">
                      <span className="flex items-center gap-1">
                        {source.type === 'merchant' ? <ShoppingCart size={10} /> : <Zap size={10} />}
                        {source.name}
                      </span>
                    </div>
                    
                    <div className="space-y-1">
                      {/* Pricing for Merchants */}
                      {source.details.price && (
                        <div className="flex flex-wrap gap-1 mb-1">
                          {source.details.price.map((p, pi) => (
                            <span key={pi} className="text-[8px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">
                              {p.quantity}x {p.item}
                            </span>
                          ))}
                        </div>
                      )}

                      {/* Coordinate Button */}
                      <button 
                        onClick={() => copyToClipboard(source.details.coords, source.name)}
                        className={`w-full py-1.5 rounded-md text-[9px] font-mono transition-all flex items-center justify-center gap-1.5 border
                          ${(source.details.coords.x === "0" && source.details.coords.y === "0" && source.details.coords.z === "0")
                            ? 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed'
                            : 'bg-white border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 text-slate-500'
                          }`}
                      >
                        <MapPin size={10} className={source.details.coords.x === "0" ? "text-slate-200" : "text-indigo-400"} />
                        {source.details.coords.x === "0" ? "UNCONFIRMED" : `${source.details.coords.x}, ${source.details.coords.y}, ${source.details.coords.z}`}
                      </button>

                      {/* Screenshot Links if available */}
                      {source.details.screenshots && (
                        <div className="flex gap-1 mt-1">
                          {source.details.screenshots.split(',').map((url, ui) => (
                            <a key={ui} href={url.trim()} target="_blank" rel="noreferrer" className="text-[8px] text-indigo-400 hover:underline flex items-center gap-0.5 bg-indigo-50 px-1 rounded">
                              IMG {ui + 1} <ExternalLink size={8} />
                            </a>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Toast */}
      {copyToast && (
        <div className="fixed bottom-6 right-6 z-[100] animate-in slide-in-from-right-4">
          <div className="bg-slate-900 text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 border border-slate-800">
            <div className="bg-indigo-600 p-1.5 rounded-lg"><ClipboardCheck size={16} /></div>
            <div>
              <p className="text-[8px] font-black uppercase tracking-widest text-indigo-400 leading-none mb-1">{copyToast.mob}</p>
              <p className="text-[11px] font-black font-mono">/compass {copyToast.coords.replace(/,/g, '')}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
